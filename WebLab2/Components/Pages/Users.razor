@page "/users"
@inject HttpClient Http
@inject NavigationManager Navigation
@using System.Net.Http.Json
@using WebLab2.HelperMethods
@using WebLab2.Models

<PageTitle>Products</PageTitle>

@if(isAdmin)
{
    <MudTable Items="@users" Striped="true" Hover="true">
        <HeaderContent>
            <MudTh>Username</MudTh>
            <MudTh>Role</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Product Name">@context.Username</MudTd>
            <MudTd DataLabel="Role">@context.Role</MudTd>
        </RowTemplate>
    </MudTable>
}
else
{
    <a href="/login">Login as an admin to view users.</a>
}

@code {
    [Inject] private AuthHelper AuthHelper { get; set; }
    private bool isAdmin;
    private List<UserDto> users = new List<UserDto>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isAdmin = await AuthHelper.IsUserAdminAsync();
            if (isAdmin)
            {
                var token = await AuthHelper.GetAccessTokenAsync();

                if (!string.IsNullOrEmpty(token))
                {
                    var requestMessage = new HttpRequestMessage(HttpMethod.Get, $"{Navigation.BaseUri}api/users");
                    requestMessage.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

                    var response = await Http.SendAsync(requestMessage);
                    if (response.IsSuccessStatusCode)
                    {
                        users = await response.Content.ReadFromJsonAsync<List<UserDto>>();
                    }
                    else
                    {
                        Console.WriteLine("Unauthorized or Forbidden access.");
                    }
                }
            }
            StateHasChanged();
        }
    }
}
